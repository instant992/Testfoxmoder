# -*- coding: utf-8 -*-
"""
–ú–æ–¥—É–ª—å –∞–Ω—Ç–∏–∫–∞–Ω–∞–ª–∞ - —É–¥–∞–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π,
–∫–æ—Ç–æ—Ä—ã–µ –ø–∏—à—É—Ç –æ—Ç –∏–º–µ–Ω–∏ –∫–∞–Ω–∞–ª–∞ (–∞–Ω–æ–Ω–∏–º–Ω–æ)
"""

from telegram import Update
from telegram.ext import CallbackContext, MessageHandler, Filters
from telegram.error import BadRequest

from MitaHelper import dispatcher, LOGGER
from MitaHelper.modules.database import is_antichannel_enabled


def check_channel_message(update: Update, context: CallbackContext):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ —É–¥–∞–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –∫–∞–Ω–∞–ª–æ–≤"""
    msg = update.effective_message
    chat = update.effective_chat
    
    if not msg or not chat:
        return
    
    # –¢–æ–ª—å–∫–æ –¥–ª—è –≥—Ä—É–ø–ø/—Å—É–ø–µ—Ä–≥—Ä—É–ø–ø
    if chat.type not in ['group', 'supergroup']:
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ sender_chat (—Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∏–º–µ–Ω–∏ –∫–∞–Ω–∞–ª–∞)
    if not msg.sender_chat:
        return
    
    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ —ç—Ç–æ —Å–∞–º —á–∞—Ç (–∞–Ω–æ–Ω–∏–º–Ω—ã–π –∞–¥–º–∏–Ω –≥—Ä—É–ø–ø—ã)
    if msg.sender_chat.id == chat.id:
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–∫–ª—é—á—ë–Ω –ª–∏ –∞–Ω—Ç–∏–∫–∞–Ω–∞–ª –¥–ª—è —ç—Ç–æ–≥–æ —á–∞—Ç–∞
    if not is_antichannel_enabled(chat.id):
        return
    
    # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∫–∞–Ω–∞–ª–∞
    try:
        msg.delete()
        LOGGER.info(
            f"–ê–Ω—Ç–∏–∫–∞–Ω–∞–ª: —É–¥–∞–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∫–∞–Ω–∞–ª–∞ '{msg.sender_chat.title}' "
            f"(ID: {msg.sender_chat.id}) –≤ —á–∞—Ç–µ {chat.title}"
        )
    except BadRequest as e:
        LOGGER.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∫–∞–Ω–∞–ª–∞: {e}")
    except Exception as e:
        LOGGER.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –∫–∞–Ω–∞–ª–∞: {e}")


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π —Å –≤—ã—Å–æ–∫–∏–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º (group=1)
# —á—Ç–æ–±—ã —Å—Ä–∞–±–∞—Ç—ã–≤–∞–ª —Ä–∞–Ω—å—à–µ –¥—Ä—É–≥–∏—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
antichannel_handler = MessageHandler(
    Filters.chat_type.groups & ~Filters.status_update,
    check_channel_message,
    run_async=True
)

dispatcher.add_handler(antichannel_handler, group=1)


__mod_name__ = "üì¢ –ê–Ω—Ç–∏–∫–∞–Ω–∞–ª"

__help__ = """
*–ó–∞—â–∏—Ç–∞ –æ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –∫–∞–Ω–∞–ª–æ–≤:*

–ö–æ–≥–¥–∞ —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∞, –±–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ—Ç
—Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –ø–∏—à—É—Ç –æ—Ç –∏–º–µ–Ω–∏ –∫–∞–Ω–∞–ª–∞.

*–ß—Ç–æ —É–¥–∞–ª—è–µ—Ç—Å—è:*
‚Ä¢ –°–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤
‚Ä¢ –°–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ª—é–±—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ (–Ω–µ —è–≤–ª—è—é—â–∏—Ö—Å—è —Å–≤—è–∑–∞–Ω–Ω—ã–º –∫–∞–Ω–∞–ª–æ–º –≥—Ä—É–ø–ø—ã)

*–ß—Ç–æ –ù–ï —É–¥–∞–ª—è–µ—Ç—Å—è:*
‚Ä¢ –°–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
‚Ä¢ –°–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –∞–Ω–æ–Ω–∏–º–Ω—ã—Ö –∞–¥–º–∏–Ω–æ–≤ –≥—Ä—É–ø–ø—ã

*–ù–∞—Å—Ç—Ä–æ–π–∫–∞:*
–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /config ‚Üí –≤—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç ‚Üí üì¢ –ê–Ω—Ç–∏–∫–∞–Ω–∞–ª
"""
